var ENV="BUILD",app=angular.module("myApp",["ngRoute","oc.lazyLoad","ngCookies"]),routerName=["login","busPrice","case","news","contact"];app.config(["$routeProvider",function(e){var t={auth:["$q","ser_log","$location","$cookies",function(e,t,a,n){if("BUILD"==ENV&&1!=n.get("isLog")&&!t.isLogin)return a.path("/"),e.reject("Not logged")}]},a=[];angular.forEach(routerName,function(e,n){a.push({url:"/"+e,option:{templateUrl:"./pages/"+e+".html",controller:e+"Ctrl",resolve:t}})}),e.when("/",{templateUrl:"./pages/"+routerName[0]+".html",controller:routerName[0]+"Ctrl"}).when(a[1].url,a[1].option).when(a[2].url,a[2].option).when(a[3].url,a[3].option).when(a[4].url,a[4].option)}]),app.directive("myAlert",function(){return{restrict:"E",template:'<div id="alert">{{alert}}</div>',replace:!0}}),app.directive("backButton",function(){return{restrict:"E",template:'<button id="back-button"><img src="./img/icon_top.png"/></button>',replace:!0,compile:function(e,t){e.bind("click",function(){$("html,body").animate({scrollTop:0},300)}),$(window).scroll(function(){$(window).scrollTop()>50?e.fadeIn(100):e.fadeOut(200)})}}}),app.directive("pagination",function(){return{restrict:"E",scope:{page:"=",maxPage:"="},template:'<div class="pagination"><ul class="pager"><li><a href="javascript:void(0)" ng-click="pageGo(1)">首页</a></li><li><a href="javascript:void(0)" ng-click="pagePre()">上一页</a></li></ul><ul><li ng-repeat="num in pageShowList" ng-class="{active: clickPage == num}"><a href="javascript:void(0)" ng-click="pageGo(num)">{{num}}</a></li></ul><ul class="pager"><li><a href="javascript:void(0)" ng-click="pageNext()">下一页</a></li><li><a href="javascript:void(0)" ng-click="pageGo(maxPage)">尾页:{{maxPage}}</a></li></ul></div>',replace:!0,link:function(e){function t(t){if(e.clickPage=t,t>4){if(e.pageShowList=[t-3,t-2,t-1,t,t+1,t+2,t+3],t>e.maxPage-3)for(var n=0;n<3-(e.maxPage-t);n++)e.pageShowList.pop()}else e.pageShowList=a.slice(0,7)}var a=[];e.page=1,e.pageShowList=[];e.$watch("maxPage",function(n,i,o){a=[];for(var r=1;r<=n;r++)a.push(r);t(e.page)});e.pageGo=function(a){e.page=a,t(e.page)},e.pagePre=function(){e.page>1&&(e.page--,t(e.page))},e.pageNext=function(){e.page<e.maxPage&&(e.page++,t(e.page))}}}}),app.controller("busPriceCtrl",["$scope","$http","$cookies","ser_api","ser_strEncode","ser_log",function(e,t,a,n,i,o){function r(){var a=n.busPrice.getData;t.get(a,{params:{page:e.page}}).success(function(t){var a=t.data;a.forEach(function(e,t){e.level+="",e.type+="",e.time+=""}),e.list=a,e.list.unshift({id:"id"}),e.maxPage=t.maxPage})}function c(){u()?r():s()}function s(){p.page=e.page,p.data.province=e.keyword[0],p.data.city=e.keyword[1],p.data.level=i.busPrice.level.encode(e.keyword[2].toUpperCase()),t.post(n.busPrice.searchData,p).success(function(t){t.results.forEach(function(e,t){e.level+="",e.type+="",e.time+=""}),e.list=t.results,e.maxPage=t.maxPage})}function u(){for(var t=!0,a=0;a<3;a++)""!=e.keyword[a]&&(t=!1);return t}var l=!1,p={page:1,data:{id:"",province:"",city:"",route:"",level:"",type:"",time:"",price:""}};e.page=1,e.clickPage=1,e.list=[],e.keyword=["","",""],e.isDelBtnShow=[!1,!1,!1],c(),e.typeToCh=function(e){return i.busPrice.type.decode(e)},e.levelToStr=function(e){return i.busPrice.level.decode(e)},e.myFilterToChComma=function(t){var a=new RegExp("[, ]");e.editItem.route=t.replace(a,"，")},e.editModify=function(t){e.isShowTabEdit=t,e.editItem=e.list[t],l=!0},e.editSave=function(a){l&&(l=!1,e.isShowTabEdit=null);var i={page:e.page,data:e.list[a]};t.post(n.busPrice.modifyData,i).success(function(e){100==e&&c()})},e.editDel=function(a){e.isShowTabEdit=null,t({url:n.busPrice.delData,method:"GET",params:{id:e.list[a].id,page:e.page}}).success(function(e){100==e&&c()})},e.editAdd=function(t){var a=e.list.slice(0),n={id:"id",province:a[t].province,city:a[t].city,level:a[t].level,type:a[t].type,time:a[t].time,route:a[t].route,price:a[t].price};e.list.splice(t+1,0,n),e.editModify(t+1)},e.searchKeyWord=function(t){for(var a=0;a<3;a++)""!=e.keyword[a]&&(e.isDelBtnShow[a]=!0);e.page=1,s()},e.searchWithout=function(t){e.isDelBtnShow[t]=!1,e.keyword[t]="",s()},e.isShowPlaceWordList=!1,e.searchLevelFocus=function(){e.isShowPlaceWordList=!0},e.searchLevelVal=function(t){e.keyword[2]=t,e.isShowPlaceWordList=!1},e.pageTo=function(){c()}}]),app.controller("caseCtrl",["$scope","$http","ser_umeditor","ser_api","ser_uploadFile",function(e,t,a,n,i){function o(){e.selectName==d[0].eng?r():c()}function r(){var a=n.case.getData;t.get(a,{params:{page:e.page}}).success(function(t){e.list=t.consults,e.list.unshift(p),e.maxPage=t.maxPage})}function c(){var a=n.case.search,i={page:e.page,type:e.selectName};t.post(a,i).success(function(t){e.list=t.consults,e.list.unshift(p),e.maxPage=t.maxPage})}function s(){u&&(u=!1,e.isShowTabEdit=null)}var u=!1;e.page=1;var l=0;e.list=[];var p={id:"id"},d=[{ch:"全部类别",eng:"all"},{ch:"食品酒饮",eng:"drink_wine"},{ch:"保健美妆",eng:"healthy_pretty"},{ch:"家电日用",eng:"appliance"},{ch:"IT通讯",eng:"IT"},{ch:"银行保险",eng:"bank"},{ch:"家建地产",eng:"land"},{ch:"服装服饰",eng:"cloth"},{ch:"餐饮娱乐",eng:"entertainment"},{ch:"教育培训",eng:"education"},{ch:"公益广告",eng:"public_service"}];e.typeList=d,e.selectName=d[0].eng,a.load(),o(),e.searchByType=function(){e.page=1,o()},e.editModify=function(t){e.isShowTabEdit=t,e.editItem=e.list[t],u=!0,l=t;var n=e.list[t].content;n?a.set(n):a.set("")},e.editSave=function(i){if(l==i){var r=[];s();var c=$("#myEditor").find("img");c.length>0&&c.each(function(){var e=$(this).attr("src"),t="";"TEST"==ENV?t=n.host:"BUILD"==ENV&&(t="http://"+window.location.host),e=e.replace(t,""),r.push(e)});var u={page:e.page,data:{id:e.list[i].id,type:e.list[i].type,title:e.list[i].title,date:e.list[i].date,logo:e.list[i].logo,origin:e.list[i].origin,content:a.get(),img:r}};t.post(n.case.add,u).success(function(e){100==e&&o()})}},e.editDel=function(a){var i=n.case.delDate;t.get(i,{params:{page:e.page,delid:e.list[a].id}}).success(function(e){100==e&&o()})},e.uploadLogo=function(t,a){var o=n.case.uploadImg;i.postImg(o,t[0],"upfile",function(t){var a=(new Date).getTime();e.$apply(function(){e.list[l].logo=n.host+t+"?"+a})})},e.uploadFile=function(e){var t=n.case.uploadImg;i.postImg(t,e[0],"upfile",function(e){var t=n.host+e;a.add("<img class=upload-img src="+t+" />")})},e.typeToCh=function(e){var t=e;return angular.forEach(d,function(a,n){e==a.eng&&(t=a.ch)}),t},e.pageTo=function(){o()}}]),app.controller("contactCtrl",["$scope","$http","ser_api",function(e,t,a){function n(){var n=a.contact.getData;t.get(n,{params:{page:e.page}}).success(function(t){e.list=t.customers,e.maxPage=t.maxPage})}e.list=[],e.page=1,n(),e.boolToStr=function(t,a){return 1==t?"":0==t?(e.isContactUnread=a,"未读"):void 0},e.editModify=function(i){var o={page:e.page,id:e.list[i].id},r=a.contact.readData;t.post(r,o).success(function(e){100==e&&n()})},e.editDel=function(i){var o=a.contact.delData;t.get(o,{params:{page:e.page,delid:e.list[i].id}}).success(function(e){100==e&&n()})},e.pageTo=function(){n()}}]),app.controller("indexCtrl",["$scope","$http","$cookies","ser_api","ser_log",function(e,t,a,n,i){function o(){for(var t=window.location.hash,a=t.split("#/")[1],n=1;n<routerName.length;n++)if(routerName[n]==a){e.isNavLiAct=n-1;break}}e.isShowContactNum=!1,e.contactNum=0,e.isNavLiAct=null,e.sleTab=function(t){e.isNavLiAct=t,3==t&&(e.isShowContactNum=!1)},window.onhashchange=function(){o()},o();var r=n.contact.getUnreadNum;t.get(r).success(function(t){t>0&&(e.isShowContactNum=!0,e.contactNum=t)})}]),app.controller("loginCtrl",["$scope","$http","$location","$cookies","ser_api","ser_log",function(e,t,a,n,i,o){function r(){var a={username:e.username,password:md5(e.password)};"TEST"==ENV?c():"BUILD"==ENV&&t.post(i.admin.login,a).success(function(e){100==e&&(n.put("isLog",1),c())})}function c(){o.isLogin=!0,e.loginKeyDown=function(){return!1},o.getPath(),a.path("/busPrice")}e.username="",e.password="",e.loginKeyDown=function(e){13==e.keyCode&&r()},e.logBtnClick=function(){r()}}]),app.controller("newsCtrl",["$scope","$http","ser_umeditor","ser_api","ser_strEncode","ser_uploadFile",function(e,t,a,n,i,o){function r(){var a=n.news.getData;t.get(a,{params:{page:e.page}}).success(function(t){var a=t.consults;a.forEach(function(e,t){e.type=e.type.toString()}),a.unshift(u),e.list=a,e.maxPage=t.maxPage})}var c=!1,s=0;e.page=1,e.list=[];var u={id:"id",title:"",origin:"",type:1,date:"",content:"",txt:""};a.load(),r(),e.typeToCh=function(e){return i.news.type.encode(e)},e.indexItem=function(t){return t>0?10*(e.page-1)+t:"new"},e.editModify=function(t){e.isShowTabEdit=t,e.editItem=e.list[t],c=!0,s=t;var n=e.list[t].content;n?a.set(n):a.set("")},e.editSave=function(i){if(s==i){var o=[];c&&(c=!1,e.isShowTabEdit=null);var u=$("#myEditor").find("img"),l="";u.length>0&&u.each(function(){var e=$(this).attr("src");"TEST"==ENV?l=n.host:"BUILD"==ENV&&(l="http://"+window.location.host),e=e.replace(l,""),o.push(e)});var p=a.get();if("BUILD"==ENV){var d=new RegExp(l,"gm");p=p.replace(d,"")}var g={page:e.page,data:{id:e.list[i].id,type:e.list[i].type,title:e.list[i].title,origin:e.list[i].origin,date:e.list[i].date,txt:a.getTxt(),content:p,img:o}};t.post(n.news.add,g).success(function(e){100==e&&r()})}},e.editDel=function(a){var i=n.news.delData;t.get(i,{params:{page:e.page,delid:e.list[a].id}}).success(function(e){100==e&&r()})},e.uploadFile=function(e){var t=n.case.uploadImg;o.postImg(t,e[0],"upfile",function(e){var t=n.host+e;a.add("<img class=upload-img src="+t+" />")})},e.pageTo=function(){r()}}]),app.factory("ser_api",function(){var e="";return"TEST"==ENV?e="http://192.168.18.23:8080":"BUILD"==ENV&&(e=""),{host:e,busPrice:{getData:e+"/xgjzx/bus/find",modifyData:e+"/xgjzx/bus/addupd",delData:e+"/xgjzx/bus/delete",searchData:e+"/xgjzx/search/found"},admin:{login:e+"/xgjzx/login/backsign"},case:{getData:e+"/xgjzx/consult/select",uploadImg:e+"/xgjzx/consult/uploadimage",add:e+"/xgjzx/consult/add",delDate:e+"/xgjzx/consult/delete",search:e+"/xgjzx/consult/search"},news:{getData:e+"/xgjzx/news/select",uploadImg:e+"/xgjzx/news/uploadimage",add:e+"/xgjzx/news/add",delData:e+"/xgjzx/news/delete"},contact:{add:e+"/xgjzx/customer/add",getData:e+"/xgjzx/customer/select",getUnreadData:e+"/xgjzx/customer/newcustomer",getReadData:e+"/xgjzx/customer/oldcustomer",getUnreadNum:e+"/xgjzx/customer/countnum",delData:e+"/xgjzx/customer/delete",readData:e+"/xgjzx/customer/updatestatus"}}}),app.factory("ser_log",["$location",function(e){var t=e.path();return{isLogin:!1,savePath:function(){t=e.path()},getPath:function(){return t}}}]),app.factory("ser_strEncode",function(){return{busPrice:{type:{decode:function(e){switch(e){case"1":return"全车";case"2":return"半车";case"3":return"海报";default:return""}},encode:function(e){switch(e){case"全车":return"1";case"半车":return"2";case"海报":return"3";default:return""}}},level:{encode:function(e){switch(e){case"S":return"1";case"A++":return"2";case"A+":return"3";case"A":return"4";case"B":return"5";case"C":return"6";case"D":return"7";default:return""}},decode:function(e){switch(e){case"1":return"S";case"2":return"A++";case"3":return"A+";case"4":return"A";case"5":return"B";case"6":return"C";case"7":return"D";default:return""}}}},news:{type:{encode:function(e){switch(e){case"1":return"资信快报";case"2":return"业界活动";case"3":return"行业动态";case"4":return"招标信息";default:return""}},decode:function(e){switch(e){case"行业动态":return"1";case"业界活动":return"2";case"行业动态":return"3";case"招标信息":return"4";default:return""}}}}}}),app.factory("ser_umeditor",["$ocLazyLoad",function(e){var t;return{load:function(){e.load([{files:["./js/lib/umeditor/umeditor.min.js"],cache:!1}]).then(function(){window.UMEDITOR_CONFIG.toolbar=["source | undo redo | bold italic underline strikethrough | superscript subscript | forecolor backcolor | removeformat |","insertorderedlist insertunorderedlist | selectall cleardoc paragraph | fontfamily fontsize","| justifyleft justifycenter justifyright justifyjustify |","link unlink | emotion video  | map","| horizontal print preview fullscreen","drafts","formula"],t=UM.getEditor("myEditor")})},get:function(){return t.getContent()},getTxt:function(){return t.getContentTxt()},add:function(e){t.setContent(e,!0)},set:function(e){t.setContent(e,!1)}}}]),app.factory("ser_uploadFile",function(){return{postImg:function(e,t,a,n){var i=new FormData;i.append(a,t);var o=new XMLHttpRequest;o.open("post",e),o.send(i),o.onreadystatechange=function(){if(4==this.readyState&&200==this.status){var e=this.response;n&&n(e)}}}}});